<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factura / Contrato - Dream Vacation (v3 layout)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{ --turquesa:#00a6c7; --turquesa-osc:#008bb5; --azul-osc:#123b48; --gris-borde:#d9e6ea; --gris-fondo:#f1f7f9; --gris-txt:#3e525a; }
    *{box-sizing:border-box}
    html,body{margin:0;background:#eaf3f6;color:var(--azul-osc);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:12px}
    .page{width:900px;margin:10px auto;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(3,23,32,.12);overflow:hidden}
    .ribbon{background:linear-gradient(135deg,var(--turquesa) 0%, #49c8de 70%, #eaf7fb 70%);padding:10px 14px}
    .ribbon-inner{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;color:#fff}
    .logo{width:96px;height:64px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(0,0,0,.06)}
    .logo img{max-width:92%;max-height:92%;object-fit:contain}
    .brand h1{margin:0;font-size:26px;line-height:1;font-weight:800;letter-spacing:.3px}
    .brand small{display:block;margin-top:2px;opacity:.95;font-weight:600;letter-spacing:.06em}
    .fact-box{background:#fff;color:var(--azul-osc);border:1px solid var(--gris-borde);border-radius:8px;padding:8px 10px;min-width:240px}
    .fact-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(--turquesa-osc);border-bottom:2px solid var(--turquesa);padding-bottom:4px;margin-bottom:6px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:4px;font-size:11px}
    .kv .v{font-weight:800}
    .content{padding:10px 12px 14px}
    .sect-title{background:var(--turquesa-osc);color:#fff;padding:4px 8px;border-radius:5px;font-size:10px;text-transform:uppercase;letter-spacing:.12em;display:inline-block;margin:4px 0 6px;font-weight:800}
    .box{border:1px solid var(--gris-borde);background:var(--gris-fondo);border-radius:8px;padding:8px;margin-bottom:8px}
    .line{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:2px 0}
    .item{display:flex;align-items:center;gap:6px;min-width:0}
    .lbl{font-weight:800;font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:#0b5163}
    .val{flex:1;min-width:120px;border-bottom:1px dashed var(--gris-borde);padding:2px 4px 1px 4px;color:var(--gris-txt)}
    .val.short{min-width:80px}
    .separator{height:1px;background:var(--gris-borde);margin:6px 0}
    table{width:100%;border-collapse:collapse}
    thead th{background:var(--turquesa-osc);color:#fff;font-size:10px;letter-spacing:.12em;text-transform:uppercase;padding:6px;border:1px solid var(--gris-borde)}
    tbody td{font-size:11.5px;color:var(--azul-osc);padding:6px;border:1px solid var(--gris-borde);background:#fff}
    tbody tr:nth-child(even) td{background:#f9fdff}
    .totals{margin-left:auto;max-width:300px;margin-top:6px}
    .tline{display:flex;justify-content:space-between;border-bottom:1px dashed var(--gris-borde);padding:4px 0;font-weight:700}
    .grand{font-size:16px;border-top:2px solid var(--turquesa);padding-top:6px;color:var(--turquesa-osc)}
    .legal{margin-top:6px;font-size:10.5px;color:#3c4d53;border-top:1px solid var(--gris-borde);padding-top:6px;line-height:1.25}
    .actions{display:flex;gap:8px;justify-content:center;padding:10px}
    .btn{border:none;border-radius:999px;background:var(--turquesa);color:#fff;font-weight:700;padding:8px 14px;cursor:pointer;font-size:12px}
    .btn.gray{background:#2e4852}
    @media print{ .actions{display:none!important} .page{box-shadow:none;border-radius:0;margin:0;width:auto} .ribbon{padding-bottom:8px} }
  </style>
</head>
<body>
  <div class="actions">
    <button id="btnExport" class="btn">Descargar PDF</button>
    <button id="btnPrint" class="btn gray">Imprimir</button>
  </div>

  <div id="printArea" class="page">
    <div class="ribbon">
      <div class="ribbon-inner">
        <div class="brand">
          <div class="logo"><img id="agencyLogo" alt="Logo"/></div>
          <div>
            <h1 id="agencyName">Dream Vacation</h1>
            <small id="agencyLegalName">Agencia Mayorista de Viajes y Turismo</small>
          </div>
        </div>
        <div class="fact-box">
          <div class="fact-title">N Factura y Contrato</div>
          <div class="kv">
            <div>Factura:</div><div id="invoiceNumber" class="v">N/A</div>
            <div>Fecha:</div><div id="invoiceDate" class="v">N/A</div>
            <div>Asesor:</div><div id="invoiceAdvisor" class="v">N/A</div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="sect">
        <span class="sect-title">Datos del titular</span>
        <div class="box">
          <div class="line">
            <div class="item"><span class="lbl">Nombre:</span><span class="val" id="clientFullName">N/A</span></div>
            <div class="item"><span class="lbl">Documento:</span><span class="val" id="clientDocument">N/A</span></div>
          </div>
          <div class="line">
            <div class="item"><span class="lbl">Correo:</span><span class="val" id="clientEmail">N/A</span></div>
            <div class="item"><span class="lbl">Telefono:</span><span class="val short" id="clientPhone">N/A</span></div>
            <div class="item" style="flex:1"><span class="lbl">Dirección:</span><span class="val" id="clientAddress">N/A</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Contacto de emergencia</span>
        <div class="box">
          <div class="line">
            <div class="item"><span class="lbl">Nombre:</span><span class="val" id="emergencyName">N/A</span></div>
            <div class="item"><span class="lbl">Celular:</span><span class="val short" id="emergencyPhone">N/A</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Datos de la reserva</span>
        <div class="box">
          <div id="travelSegmentsList"></div>
          <template id="travelSegmentTemplate">
            <div class="line travel-segment">
              <div class="item"><span class="lbl">Origen:</span><span class="val short" data-field="origin">N/A</span></div>
              <div class="item"><span class="lbl">Destino:</span><span class="val short" data-field="destination">N/A</span></div>
              <div class="item"><span class="lbl">Ida:</span><span class="val short" data-field="departure">N/A</span></div>
              <div class="item"><span class="lbl">Regreso:</span><span class="val short" data-field="return">N/A</span></div>
            </div>
          </template>
          <div class="line">
            <div class="item"><span class="lbl">Noches:</span><span class="val short" id="travelNights">0</span></div>
            <div class="item"><span class="lbl">Das:</span><span class="val short" id="travelDays">0</span></div>
            <div class="item"><span class="lbl">Pasajeros:</span><span class="val" id="passengerTotals">ADT(0), CHD(0), INF(0)</span></div>
          </div>
          <div class="separator"></div>
          <div id="flightSegmentsList"></div>
          <template id="flightSegmentTemplate">
            <div class="flight-segment">
              <div class="line">
                <div class="item"><span class="lbl">Aerolínea:</span><span class="val" data-field="airline">N/A</span></div>
                <div class="item"><span class="lbl">Plan:</span><span class="val short" data-field="category">N/A</span></div>
                <div class="item" style="flex:1"><span class="lbl">Equipaje:</span><span class="val" data-field="baggage">-</span></div>
              </div>
              <div class="line">
                <div class="item" style="flex:1"><span class="lbl">Ciclo de vuelo:</span><span class="val" data-field="cycle">N/A</span></div>
              </div>
            </div>
          </template>
          <div class="separator"></div>
          <div id="hotelSegmentsList"></div>
          <template id="hotelSegmentTemplate">
            <div class="hotel-segment">
              <div class="line">
                <div class="item"><span class="lbl">Hotel:</span><span class="val" data-field="name">N/A</span></div>
                <div class="item"><span class="lbl">Habitación:</span><span class="val" data-field="room">N/A</span></div>
                <div class="item"><span class="lbl">Plan de alimentación:</span><span class="val" data-field="mealPlan">N/A</span></div>
              </div>
              <div class="line">
                <div class="item" style="flex:1"><span class="lbl">(N habitaciones / ADT / CHD / INF):</span><span class="val" data-field="accommodations">-</span></div>
              </div>
            </div>
          </template>
          <div class="line">
            <div class="item" style="flex:1"><span class="lbl">Otras inclusiones:</span><span class="val" id="otherInclusions">-</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <span class="sect-title">Traslados</span>
            <div class="box"><div id="transfersSummary2" class="text-[11.5px] text-[color:var(--gris-txt)]">No hay traslados registrados.</div></div>
          </div>
          <div>
            <span class="sect-title">Tours</span>
            <div class="box"><div id="toursContent" class="text-[11.5px] text-[color:var(--gris-txt)]">No hay tours o servicios adicionales registrados.</div></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Detalles de cobro</span>
        <table>
          <thead>
            <tr>
              <th style="width:10%">Cant.</th>
              <th>Descripción</th>
              <th style="width:18%">Vr. Unit.</th>
              <th style="width:18%">Vr. Total</th>
            </tr>
          </thead>
          <tbody id="paymentsBody">
            <tr><td colspan="4" class="text-center">No hay informacin de pagos.</td></tr>
          </tbody>
        </table>
        <div class="totals">
          <div class="tline"><span>Subtotal</span><span id="paymentsSubtotal"></span></div>
          <div class="tline"><span>Recargo</span><span id="paymentsSurcharge"></span></div>
          <div class="tline grand"><span>Total</span><span id="paymentsTotal"></span></div>
          <div style="font-size:11px;color:var(--gris-txt);margin-top:2px">En letras: <strong id="paymentsTotalWords"></strong></div>
        </div>
      </div>

      <div class="sect" style="margin-top:6px">
        <div class="grid grid-cols-2 gap-2">
          <div class="box">
            <div class="h-10 flex items-center justify-center border border-[color:var(--gris-borde)] bg-white rounded mb-1">Firma asesor</div>
            <div id="signatureAdvisor" class="text-center text-[11px] text-[color:var(--gris-txt)]">N/A</div>
          </div>
          <div class="box">
            <div class="h-10 flex items-center justify-center border border-[color:var(--gris-borde)] bg-white rounded mb-1">Firma titular</div>
            <div id="signatureClient" class="text-center text-[11px] text-[color:var(--gris-txt)]">N/A</div>
          </div>
        </div>
      </div>

      <div class="legal">
        <div id="invoiceMessage"></div>
        <div id="footerTerms"></div>
        <div id="footerNote"></div>
        <div style="margin-top:4px;opacity:.95">
          ESTA FACTURA DE VENTA SE ASIMILA EN TODOS SUS EFECTOS A UNA LETRA DE CAMBIO SEGN ART.774 DEL C. DE CIO.
        </div>
      </div>
    </div>
  </div>

  <script>
    const parseDate = (v)=>{ if(!v) return null; if(v instanceof Date) return v; const s=String(v); const d=new Date(s); if(!isNaN(d)) return d; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m? new Date(Date.UTC(+m[1],+m[2]-1,+m[3])): null; };
    const two=(n)=>String(n).padStart(2,'0');
    const formatDate=(v)=>{ const d=parseDate(v); if(!d) return 'N/A'; return two(d.getUTCDate())+'/'+two(d.getUTCMonth()+1)+'/'+d.getUTCFullYear(); };
    const formatCurrency=(n,cur='COP')=>{ const x=Number(n); if(!Number.isFinite(x)) return ''; try{ return new Intl.NumberFormat('es-CO',{style:'currency',currency:cur,maximumFractionDigits:0}).format(x);}catch{return cur+' '+x.toLocaleString('es-CO');} };
    const numeroALetras=(num)=>{ if(!Number.isFinite(num)) return ''; const u=['','UNO','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE']; const e={10:'DIEZ',11:'ONCE',12:'DOCE',13:'TRECE',14:'CATORCE',15:'QUINCE',16:'DIECISEIS',17:'DIECISIETE',18:'DIECIOCHO',19:'DIECINUEVE',20:'VEINTE',21:'VEINTIUNO',22:'VEINTIDOS',23:'VEINTITRES',24:'VEINTICUATRO',25:'VEINTICINCO',26:'VEINTISEIS',27:'VEINTISIETE',28:'VEINTIOCHO',29:'VEINTINUEVE'}; const d=['','','VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA']; const c=['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS','NOVECIENTOS']; const sec=(n)=>{ if(n===0) return ''; if(n<10) return u[n]; if(n<30) return e[n]; if(n<100){const D=Math.floor(n/10),R=n%10;return d[D]+(R?' Y '+u[R]:'');} if(n===100) return 'CIEN'; if(n<1000){const C=Math.floor(n/100),R=n%100;return c[C]+(R?' '+sec(R):'');} if(n<1e6){const M=Math.floor(n/1e3),R=n%1e3;return (M===1?'MIL':sec(M)+' MIL')+(R?' '+sec(R):'');} if(n<1e9){const MM=Math.floor(n/1e6),R=n%1e6;return (MM===1?'UN MILLON':sec(MM)+' MILLONES')+(R?' '+sec(R):'');} const B=Math.floor(n/1e9),R2=n%1e9;return (B===1?'UN BILLON':sec(B)+' BILLONES')+(R2?' '+sec(R2):''); }; const ent=Math.floor(Math.abs(num)); const cents=Math.round((Math.abs(num)-ent)*100); let out=ent===0?'CERO':sec(ent); out+=' PESOS'; if(cents>0) out+=' CON '+String(cents).padStart(2,'0')+'/100'; return out; };

    const setText=(id,v,empty='N/A')=>{ const el=document.getElementById(id); if(el) el.textContent=v? v: empty; };
    const fillTable=(tbodyId,rows,emptyCols,emptyText)=>{ const tb=document.getElementById(tbodyId); if(!tb) return; tb.innerHTML=''; if(!rows||!rows.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=emptyCols; td.textContent=emptyText; td.style.textAlign='center'; tr.appendChild(td); tb.appendChild(tr); return;} rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }); tb.appendChild(tr); }); };

    const collectItems=(...sources)=>{
      const out=[];
      const seenObjects=new WeakSet();
      const seenPrimitives=new Set();
      const hintKeys=['origin','origen','destination','destino','from','to','departure','arrival','ida','vuelta','return','regreso','arrivaldate','departuredate','fecha','airline','aerolinea','carrier','hotel','habitacion','room','city','ciudad','segment','tramo','stay','vuelo','flight','segmento','destin','night','dia','ruta'];
      const nestedKeys=['segments','segment','segmentList','segmentos','legs','leg','tramos','routes','route','destinations','destinos','items','item','detail','details','detalle','detalles','values','value','list','lists','collection','collections','stays','stayList','hotels','hoteles','rooms','habitaciones','paths','path','itinerary','itineraries','flights','viajes','entries','elementos','records','accommodations','accommodationList','hotelsList','roomsList','hotelList'];
      const push=(value)=>{
        if(!value) return;
        if(Array.isArray(value)){
          value.forEach(push);
          return;
        }
        if(value instanceof Map){
          value.forEach(v=>push(v));
          return;
        }
        if(value instanceof Set){
          value.forEach(v=>push(v));
          return;
        }
        if(typeof value==='object'){
          if(seenObjects.has(value)) return;
          if(typeof value.length==='number' && value.length>=0){
            Array.from(value).forEach(push);
            return;
          }
          seenObjects.add(value);
          const entries=Object.entries(value);
          if(entries.length){
            const numericKeys=entries.every(([k])=>!Number.isNaN(Number(k)));
            if(numericKeys){
              entries.sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([,v])=>push(v));
              return;
            }
            const lowerKeys=entries.map(([k])=>k.toLowerCase());
            const isSegment=lowerKeys.some(k=>hintKeys.some(h=>k.includes(h)));
            if(isSegment){
              out.push(value);
            }else{
              let usedNested=false;
              nestedKeys.forEach(nk=>{
                if(nk in value){
                  usedNested=true;
                  push(value[nk]);
                }
              });
              if(!usedNested) out.push(value);
            }
          }else{
            out.push(value);
          }
          return;
        }
        const primitiveKey=`${typeof value}:${value}`;
        if(seenPrimitives.has(primitiveKey)) return;
        seenPrimitives.add(primitiveKey);
        out.push(value);
      };
      sources.forEach(push);
      return out.filter(Boolean);
    };

    const resolveValue=(source,paths=[],opts={})=>{
      const allowObjects=opts.allowObjects===true;
      if(!source) return undefined;
      for(const rawPath of paths){
        if(!rawPath) continue;
        const parts=Array.isArray(rawPath)?rawPath:(String(rawPath).split('.'));
        let value=source;
        let failed=false;
        for(const part of parts){
          if(value==null){ failed=true; break; }
          if(typeof value!=='object' && typeof value!=='function'){ failed=true; break; }
          if(Object.prototype.hasOwnProperty.call(value,part)){ value=value[part]; continue; }
          if(part in value){ value=value[part]; continue; }
          failed=true; break;
        }
        if(failed) continue;
        if(value===undefined || value===null || value==='') continue;
        if(typeof value==='object' && !(value instanceof Date) && !allowObjects) continue;
        return value;
      }
      return undefined;
    };

    const displayText=(value)=>{
      if(value===undefined || value===null) return '';
      if(typeof value==='string') return value;
      if(typeof value==='number') return String(value);
      if(value instanceof Date) return formatDate(value);
      if(typeof value==='object'){
        const keys=['city','name','label','description','title','code','text','airport'];
        for(const k of keys){ if(value[k]) return String(value[k]); }
        if(value.toString && value.toString!==Object.prototype.toString) return value.toString();
      }
      return '';
    };

    const buildBaggageSummary=(baggage)=>{
      if(!baggage) return '';
      if(Array.isArray(baggage)){
        return baggage.map(b=>buildBaggageSummary(b)).filter(Boolean).join(' | ');
      }
      if(typeof baggage==='string') return baggage;
      if(typeof baggage!=='object') return '';
      const parts=[];
      const hand=baggage.summary||baggage.hand||baggage.carryOn||baggage.cabina||baggage.cabin;
      const hold=baggage.hold||baggage.bodega||baggage.checked||baggage.checkedBag||baggage.checkedBaggage;
      const additional=baggage.additional||baggage.extra||baggage.description;
      if(hand) parts.push(`Articulo de mano: ${hand}`);
      if(baggage.cabin && baggage.cabin!==hand) parts.push(`Cabina: ${baggage.cabin}`);
      if(hand && !parts.some(p=>p.includes('Cabina')) && (baggage.carryOn||baggage.hand)){ parts.push(`Cabina: ${hand}`); }
      if(hold) parts.push(`Bodega: ${hold}`);
      if(baggage.allowance) parts.push(String(baggage.allowance));
      if(additional) parts.push(String(additional));
      if(!parts.length && baggage.label) parts.push(String(baggage.label));
      if(!parts.length && baggage.name) parts.push(String(baggage.name));
      return parts.join(' | ');
    };

    const normalizeAccommodationEntries=(list)=>{
      if(!Array.isArray(list)) return [];
      return list
        .filter(Boolean)
        .map((acc,index)=>({
          index: index + 1,
          rooms: Number(acc?.rooms ?? acc?.room_quantity ?? acc?.roomQuantity ?? acc?.roomsCount ?? 0) || 0,
          adt: Number(acc?.adt ?? acc?.adults ?? acc?.adultCount ?? 0) || 0,
          chd: Number(acc?.chd ?? acc?.children ?? acc?.childCount ?? 0) || 0,
          inf: Number(acc?.inf ?? acc?.infants ?? acc?.infantCount ?? 0) || 0,
        }))
        .filter(entry => (entry.rooms || entry.adt || entry.chd || entry.inf));
    };

    const formatAccommodationEntry=(entry={})=>{
      const rooms=Number(entry.rooms)||0;
      const adt=Number(entry.adt)||0;
      const chd=Number(entry.chd)||0;
      const inf=Number(entry.inf)||0;
      return `${rooms} / ADT:${adt} CHD:${chd} INF:${inf}`;
    };

    const formatAccommodationCollection=(entries=[])=>{
      if(!entries.length) return '';
      return entries.map(e=>formatAccommodationEntry(e)).join('<br/>');
    };

    const formatTransferTypeLabel=(transfer={})=>{
      const raw=String(transfer.type || '').toLowerCase();
      if(raw==='arrival' || raw==='in'){
        return 'Llegada (In)';
      }
      if(raw==='departure' || raw==='out'){
        return 'Salida (Out)';
      }
      if(typeof transfer.label==='string' && transfer.label.trim()){
        return transfer.label.trim();
      }
      if(transfer.type){
        return transfer.type;
      }
      return 'Traslado';
    };

    const buildTransferSummaryLine=(transfer={}, formatter=formatDate)=>{
      const segmentLabel = transfer.segmentLabel || (transfer.segmentIndex ? `Tramo ${transfer.segmentIndex}` : '');
      const typeLabel = formatTransferTypeLabel(transfer);
      const dateText = transfer.date ? `Fecha: ${formatter(transfer.date)}` : '';
      const timeText = transfer.time ? `Hora: ${transfer.time}` : '';
      const pickupText = transfer.pickup ? `Recogida: ${transfer.pickup}` : '';
      const dropoffText = transfer.dropoff ? `Destino: ${transfer.dropoff}` : '';

      const parts = [];
      if (segmentLabel) parts.push(segmentLabel);
      if (typeLabel) parts.push(`Tipo: ${typeLabel}`);
      if (dateText) parts.push(dateText);
      if (timeText) parts.push(timeText);
      if (pickupText) parts.push(pickupText);
      if (dropoffText) parts.push(dropoffText);

      return parts.join(' · ') || typeLabel || 'Traslado';
    };

    const groupTransfersBySegment=(details=[])=>{
      const groups=new Map();
      details.forEach((transfer)=>{
        if(!transfer || typeof transfer!=='object') return;
        const label = transfer.segmentLabel || (transfer.segmentIndex ? `Tramo ${transfer.segmentIndex}` : 'Traslado');
        const indexKey = transfer.segmentIndex ?? 'none';
        const key = `${label}__${indexKey}`;
        if(!groups.has(key)){
          groups.set(key, { segmentLabel: label, entries: [] });
        }
        groups.get(key).entries.push(transfer);
      });
      return Array.from(groups.values());
    };

    const buildTransferGroupLine=(group={}, formatter=formatDate)=>{
      const label = group.segmentLabel || 'Traslado';
      const typeLabels = [];
      (group.entries || []).forEach((entry)=>{
        const typeLabel = formatTransferTypeLabel(entry);
        if(typeLabel && !typeLabels.includes(typeLabel)){
          typeLabels.push(typeLabel);
        }
      });

      const additionalDetails = [];
      const hasSingleEntry = (group.entries || []).length === 1;
      if(hasSingleEntry){
        const entry = group.entries[0];
        const summary = buildTransferSummaryLine(entry, formatter);
        if(summary && summary !== label){
          return summary;
        }
      }

      const typePart = typeLabels.length ? typeLabels.map((t)=>`Tipo: ${t}`).join(' / ') : '';
      const extraDates = [];
      (group.entries || []).forEach((entry)=>{
        if(entry.date){
          const dateText = formatter(entry.date);
          if(dateText && !extraDates.includes(dateText)){
            extraDates.push(dateText);
          }
        }
      });
      if(extraDates.length){
        additionalDetails.push(`Fechas: ${extraDates.join(' / ')}`);
      }

      const parts=[label];
      if(typePart) parts.push(typePart);
      additionalDetails.forEach(detail=>parts.push(detail));

      return parts.join(' · ');
    };

    const renderTravelSection = (travel = {}, extraSegments = []) => {
      const container = document.getElementById('travelSegmentsList');
      const template = document.getElementById('travelSegmentTemplate');
      if (!container || !template) return;
      container.innerHTML = '';

      const segments = collectItems(
        extraSegments,
        travel.segments,
        travel.segment,
        travel.segmentList,
        travel.segmentsList,
        travel.itinerary,
        travel.routes,
        travel.tramos,
        travel.trayectos,
        travel.sections,
        travel.destinations,
        travel.destinos,
        travel.detail,
        travel.details,
        travel.list,
        travel.legs,
        travel.paths,
        travel.segmentos
      );

      if (segments.length === 0 && (travel.origin || travel.destination || travel.departureDate || travel.returnDate)) {
        segments.push(travel);
      }

      if (segments.length > 0) {
        container.style.display = '';
        segments.forEach((seg, index) => {
          if (index > 0) {
            const separator = document.createElement('div');
            separator.className = 'separator';
            container.appendChild(separator);
          }
          const clone = template.content.firstElementChild.cloneNode(true);
          const origin = displayText(resolveValue(seg, ['origin', 'origen', 'from', 'departure.city', 'departureCity', 'departure.name', 'departure.label', 'departure.airport', 'inicio.city', 'start.city', 'start', 'source', 'salida.origen', 'ciudadSalida', 'originCity', 'ciudadOrigen'], { allowObjects: true }) ?? seg.departureCity);
          const destination = displayText(resolveValue(seg, ['destination', 'destino', 'to', 'arrival.city', 'arrivalCity', 'arrival.name', 'arrival.label', 'arrival.airport', 'fin.city', 'end.city', 'target', 'destiny', 'ciudadLlegada', 'destinationCity', 'ciudadDestino'], { allowObjects: true }) ?? seg.arrivalCity);
          const departureVal = resolveValue(seg, ['departureDate', 'fechaIda', 'departure.date', 'departureDateTime', 'departure', 'startDate', 'fromDate', 'ida', 'fechaSalida', 'salida', 'fechaInicio']);
          const returnVal = resolveValue(seg, ['returnDate', 'fechaRegreso', 'arrival.date', 'arrivalDate', 'arrivalDateTime', 'return', 'endDate', 'toDate', 'vuelta', 'regreso', 'llegada', 'fechaFin']);
          const setField = (selector, value, isDate = false) => {
            const el = clone.querySelector(selector);
            if (!el) return;
            if (isDate) el.textContent = formatDate(value);
            else el.textContent = value ? value : 'N/A';
          };
          setField('[data-field="origin"]', origin || 'N/A');
          setField('[data-field="destination"]', destination || 'N/A');
          setField('[data-field="departure"]', departureVal, true);
          setField('[data-field="return"]', returnVal, true);
          container.appendChild(clone);
        });
      } else {
        container.style.display = 'none';
      }
    };

    const renderFlightSection = (flights = {}, extraSegments = []) => {
      const container = document.getElementById('flightSegmentsList');
      const template = document.getElementById('flightSegmentTemplate');
      if (!container || !template) return;
      container.innerHTML = '';

      const segments = collectItems(
        extraSegments,
        flights.segment,
        flights.segmentList,
        flights.segments,
        flights.segmentsList,
        flights.itinerary,
        flights.routes,
        flights.tramos,
        flights.paths,
        flights.segmentos,
        flights.detail,
        flights.details,
        flights.flights,
        flights.list
      );

      const flightSegmentsFiltered = segments.filter((seg) => {
        if (!seg || typeof seg !== 'object') {
          return true;
        }

        const hasCompositeInfo =
          Array.isArray(seg.itineraries) ||
          Array.isArray(seg.segments) ||
          Array.isArray(seg.segmentList) ||
          'itineraries' in seg ||
          'cycle' in seg ||
          'flight_cycle' in seg ||
          'category' in seg ||
          'class' in seg ||
          'pnr' in seg ||
          'plan' in seg;

        const hasFlightNumber = Boolean(seg.flightNumber || seg.flight_number);

        if (hasFlightNumber && !hasCompositeInfo) {
          return false;
        }

        return true;
      });

      if (flightSegmentsFiltered.length === 0 && (flights.airline || flights.category || flights.cycle)) {
        flightSegmentsFiltered.push(flights);
      }

      if (flightSegmentsFiltered.length > 0) {
        container.style.display = '';
        flightSegmentsFiltered.forEach((seg, index) => {
          if (index > 0) {
            const sep = document.createElement('div');
            sep.className = 'separator';
            container.appendChild(sep);
          }
          const clone = template.content.firstElementChild.cloneNode(true);
          const airline = displayText(resolveValue(seg, ['airline', 'aerolinea', 'carrier', 'airline.name', 'carrier.name', 'marketingCarrier', 'operatingCarrier', 'carrierDescription', 'line'], { allowObjects: true }) ?? seg.airlineCode);
          const category = displayText(resolveValue(seg, ['category', 'class', 'fareClass', 'serviceClass', 'cabin', 'plan', 'categoria']));
          const cycle = displayText(resolveValue(seg, ['cycle', 'route', 'itinerary', 'summary', 'description', 'ciclo', 'trayecto', 'info', 'cicloVuelo', 'itinerario']));
          const baggageText = buildBaggageSummary(seg.baggage || seg.baggageAllowance || seg.baggageInfo || seg.baggageIncluded || seg.baggageSummary || seg.equipaje);
          const setField = (selector, value, empty = 'N/A') => {
            const el = clone.querySelector(selector);
            if (el) el.textContent = value ? value : empty;
          };
          setField('[data-field="airline"]', airline);
          setField('[data-field="category"]', category);
          setField('[data-field="baggage"]', baggageText, '-');
          setField('[data-field="cycle"]', cycle);
          container.appendChild(clone);
        });
      } else {
        container.style.display = 'none';
      }
    };

    const renderHotelSection = (hotel = {}, hotelList = []) => {
      const container = document.getElementById('hotelSegmentsList');
      const template = document.getElementById('hotelSegmentTemplate');
      if (!container || !template) return;
      container.innerHTML = '';

      const segments = collectItems(
        hotelList,
        hotel.segment,
        hotel.segments,
        hotel.list,
        hotel.stays,
        hotel.hotels,
        hotel.details,
        hotel.rooms,
        hotel.roomsList,
        hotel.segmentos,
        hotel.hotelSegments,
        hotel.detalle,
        hotel.detalles
      );

      if (segments.length === 0 && (hotel.name || hotel.roomType || hotel.mealPlan)) {
        segments.push(hotel);
      }

      const seenSegmentKeys = new Set();
      const filteredSegments = [];
      const buildSegmentKey = (seg = {}) => {
        const id = seg.id || seg.hotel_id || seg.segment_id || seg.segmentId || seg.reservation_hotel_id || '';
        const index = seg.index != null ? `#${seg.index}` : '';
        const name = (seg.name || seg.hotelName || seg.label || '').toString().toLowerCase();
        const roomType = (seg.roomType || seg.room || '').toString().toLowerCase();
        const checkIn = (seg.checkIn || seg.check_in || seg.start_date || seg.startDate || '').toString().slice(0, 10);
        const checkOut = (seg.checkOut || seg.check_out || seg.end_date || seg.endDate || '').toString().slice(0, 10);
        const mealPlan = (seg.mealPlan || seg.plan || '').toString().toLowerCase();
        const baseKey = [id, index, name, roomType, mealPlan, checkIn, checkOut].filter(Boolean).join('|');
        if (baseKey) return baseKey;
        try {
          return JSON.stringify({
            name,
            roomType,
            mealPlan,
            checkIn,
            checkOut,
            accommodations: normalizeAccommodationEntries(seg.accommodations || []),
          });
        } catch {
          return `${name}|${roomType}|${mealPlan}|${checkIn}|${checkOut}`;
        }
      };

      segments.forEach(seg => {
        if (!seg || typeof seg !== 'object') {
          return;
        }
        const key = buildSegmentKey(seg);
        if (seenSegmentKeys.has(key)) {
          return;
        }
        seenSegmentKeys.add(key);
        filteredSegments.push(seg);
      });

      if (filteredSegments.length > 0) {
        container.style.display = '';
        filteredSegments.forEach((seg, index) => {
          if (index > 0) {
            const sep = document.createElement('div');
            sep.className = 'separator';
            container.appendChild(sep);
          }
          const clone = template.content.firstElementChild.cloneNode(true);
          const name = displayText(resolveValue(seg, ['name', 'hotelName', 'label', 'title', 'hotel', 'nombreHotel'], { allowObjects: true }) ?? seg.name);
          const room = displayText(resolveValue(seg, ['roomType', 'room', 'room.name', 'roomDescription', 'category', 'habitacion', 'tipoHabitacion', 'habitacionDescripcion']));
          const mealPlan = displayText(resolveValue(seg, ['mealPlan', 'plan', 'board', 'boardPlan', 'regime', 'pension', 'alimentacion', 'meal', 'planAlimentacion']));
          const setField = (selector, value) => {
            const el = clone.querySelector(selector);
            if (el) el.textContent = value ? value : 'N/A';
          };
          setField('[data-field="name"]', name);
          setField('[data-field="room"]', room);
          setField('[data-field="mealPlan"]', mealPlan);
          const segmentEntries = normalizeAccommodationEntries(seg.accommodations);
          const segmentHtml = formatAccommodationCollection(segmentEntries);
          const accommodationsField = clone.querySelector('[data-field="accommodations"]');
          if (accommodationsField) {
            if (segmentHtml) {
              accommodationsField.innerHTML = segmentHtml;
            } else {
              accommodationsField.textContent = '-';
            }
          }
          container.appendChild(clone);
        });
      } else {
        container.style.display = 'none';
      }
    };

    const renderInvoice=(data={})=>{
      const { agency={}, invoice={}, titular={}, emergencyContact={}, travel={}, flights={}, hotel={}, passengers={}, transfers={}, tours=[], payments={}, footer={}, signatures={} } = data;
      if(agency.logoUrl){ const lg=document.getElementById('agencyLogo'); lg.src=agency.logoUrl; }
      setText('agencyName', agency.name || 'Dream Vacation');
      setText('agencyLegalName', agency.legalName || 'Agencia Mayorista de Viajes y Turismo');
      setText('invoiceNumber', invoice.number || 'N/A');
      setText('invoiceDate', formatDate(invoice.issueDate));
      setText('invoiceAdvisor', invoice.advisorName || 'N/A');
      setText('clientFullName', titular.fullName||'N/A');
      setText('clientDocument', (titular.documentType?titular.documentType+' ':'') + (titular.document||'N/A'));
      setText('clientEmail', titular.email||'N/A');
      setText('clientPhone', titular.phone||'N/A');
      setText('clientAddress', titular.address||'N/A');
      setText('emergencyName', emergencyContact.name||'N/A');
      setText('emergencyPhone', emergencyContact.phone||'N/A');
      const travelExtraSegments=collectItems(
        data.travelSegments,
        data.travelSegmentsList,
        data.travelItinerary,
        data.travelRoutes,
        data.travelTramos,
        data.travelDestinos,
        data.travelDetails
      );
      renderTravelSection(travel, travelExtraSegments);
      setText('travelNights', Number.isFinite(travel.nights)?travel.nights:'0');
      setText('travelDays', Number.isFinite(travel.days)?travel.days:'0');
      const adt = passengers.totals?.adt ?? 0;
      const chd = passengers.totals?.chd ?? 0;
      const inf = passengers.totals?.inf ?? 0;
      document.getElementById('passengerTotals').textContent = `ADT(${adt}), CHD(${chd}), INF(${inf})`;
      const flightExtraSegments=collectItems(
        data.flightSegments,
        data.flightsSegments,
        data.flightList,
        data.flightRoutes,
        data.flightDetails,
        data.flightItinerary,
        data.flightLegs
      );
      renderFlightSection(flights, flightExtraSegments);
      const hotelExtraList=collectItems(
        data.hotels,
        data.hotelList,
        data.hotelSegments,
        data.hotelsList,
        data.hotelDetails,
        data.hotelStays
      );
      renderHotelSection(hotel, hotelExtraList);
      const other = [];
      if(Array.isArray(data.assistance)&&data.assistance.length){
        other.push('Asistencias: '+data.assistance.map(a=>a.planType||a.provider).filter(Boolean).join(', '));
      }
      document.getElementById('otherInclusions').textContent = other.length? other.join(' | ') : '';
      const transfersSummaryEl = document.getElementById('transfersSummary2');
      if (transfersSummaryEl) {
        const groupedTransfers = Array.isArray(transfers.detail)
          ? groupTransfersBySegment(transfers.detail)
          : [];
        const transferLines = groupedTransfers
          .map((group) => buildTransferGroupLine(group, formatDate))
          .filter(Boolean);
        if (transferLines.length) {
          transfersSummaryEl.innerHTML = '';
          transferLines.forEach((line) => {
            const div = document.createElement('div');
            div.textContent = line;
            transfersSummaryEl.appendChild(div);
          });
        } else {
          transfersSummaryEl.textContent = 'No hay traslados registrados.';
        }
      }
      const toursRows = Array.isArray(tours) ? tours.filter(Boolean).map((t,i)=> `${i+1}. ${t.name||'Servicio'} ${t.date?(' - '+formatDate(t.date)):''}`) : [];
      const toursBox = document.getElementById('toursContent');
      toursBox.innerHTML = toursRows.length ? '<ul style="margin:2px 0 2px 16px">'+toursRows.map(x=>`<li>${x}</li>`).join('')+'</ul>' : 'No hay tours o servicios adicionales registrados.';
      const rows = Array.isArray(payments.lineItems) ? payments.lineItems.map(li=>[ li.quantity??0, li.label||li.code||'Concepto', formatCurrency(li.unitPrice, payments.currency||'COP'), formatCurrency(li.amount, payments.currency||'COP') ]) : [];
      fillTable('paymentsBody', rows, 4, 'No hay informacin de pagos.');
      setText('paymentsSubtotal', formatCurrency(payments.subtotal||0, payments.currency||'COP'));
      setText('paymentsSurcharge', formatCurrency(payments.surcharge||0, payments.currency||'COP'));
      setText('paymentsTotal', formatCurrency(payments.total||0, payments.currency||'COP'));
      document.getElementById('paymentsTotalWords').textContent = numeroALetras(Math.round(payments.total||0)) || '';
      setText('signatureAdvisor', signatures.advisor||'N/A');
      setText('signatureClient', signatures.client||'N/A');
      document.getElementById('invoiceMessage').textContent = footer.invoiceMessage||'';
      document.getElementById('footerTerms').textContent = footer.terms||'';
      document.getElementById('footerNote').textContent = footer.footerNote||footer.contractMessage||'';
    };

    window.renderInvoice = renderInvoice;
    window.numeroALetras = numeroALetras;
    document.getElementById('btnExport').addEventListener('click', () => {
      const area = document.getElementById('printArea');
      const filename = document.getElementById('invoiceNumber').textContent || 'Factura';
      const opt = { margin: [8,8,8,8], filename: filename + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: [8.5, 13], orientation: 'portrait' } };
      html2pdf().set(opt).from(area).save();
    });
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
  </script>
</body>
</html>
