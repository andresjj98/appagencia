<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factura / Contrato - Dream Vacation (v3 layout)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{ --turquesa:#00a6c7; --turquesa-osc:#008bb5; --azul-osc:#123b48; --gris-borde:#d9e6ea; --gris-fondo:#f1f7f9; --gris-txt:#3e525a; }
    *{box-sizing:border-box}
    html,body{margin:0;background:#eaf3f6;color:var(--azul-osc);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:12px}
    .page{width:900px;margin:10px auto;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(3,23,32,.12);overflow:hidden}
    .ribbon{background:linear-gradient(135deg,var(--turquesa) 0%, #49c8de 70%, #eaf7fb 70%);padding:10px 14px}
    .ribbon-inner{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;color:#fff}
    .logo{width:96px;height:64px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(0,0,0,.06)}
    .logo img{max-width:92%;max-height:92%;object-fit:contain}
    .brand h1{margin:0;font-size:26px;line-height:1;font-weight:800;letter-spacing:.3px}
    .brand small{display:block;margin-top:2px;opacity:.95;font-weight:600;letter-spacing:.06em}
    .fact-box{background:#fff;color:var(--azul-osc);border:1px solid var(--gris-borde);border-radius:8px;padding:8px 10px;min-width:240px}
    .fact-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(--turquesa-osc);border-bottom:2px solid var(--turquesa);padding-bottom:4px;margin-bottom:6px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:4px;font-size:11px}
    .kv .v{font-weight:800}
    .content{padding:10px 12px 14px}
    .sect-title{background:var(--turquesa-osc);color:#fff;padding:4px 8px;border-radius:5px;font-size:10px;text-transform:uppercase;letter-spacing:.12em;display:inline-block;margin:4px 0 6px;font-weight:800}
    .box{border:1px solid var(--gris-borde);background:var(--gris-fondo);border-radius:8px;padding:8px;margin-bottom:8px}
    .line{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:2px 0}
    .item{display:flex;align-items:center;gap:6px;min-width:0}
    .lbl{font-weight:800;font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:#0b5163}
    .val{flex:1;min-width:120px;border-bottom:1px dashed var(--gris-borde);padding:2px 4px 1px 4px;color:var(--gris-txt)}
    .val.short{min-width:80px}
    .separator{height:1px;background:var(--gris-borde);margin:6px 0}
    table{width:100%;border-collapse:collapse}
    thead th{background:var(--turquesa-osc);color:#fff;font-size:10px;letter-spacing:.12em;text-transform:uppercase;padding:6px;border:1px solid var(--gris-borde)}
    tbody td{font-size:11.5px;color:var(--azul-osc);padding:6px;border:1px solid var(--gris-borde);background:#fff}
    tbody tr:nth-child(even) td{background:#f9fdff}
    .totals{margin-left:auto;max-width:300px;margin-top:6px}
    .tline{display:flex;justify-content:space-between;border-bottom:1px dashed var(--gris-borde);padding:4px 0;font-weight:700}
    .grand{font-size:16px;border-top:2px solid var(--turquesa);padding-top:6px;color:var(--turquesa-osc)}
    .legal{margin-top:6px;font-size:10.5px;color:#3c4d53;border-top:1px solid var(--gris-borde);padding-top:6px;line-height:1.25}
    .actions{display:flex;gap:8px;justify-content:center;padding:10px}
    .btn{border:none;border-radius:999px;background:var(--turquesa);color:#fff;font-weight:700;padding:8px 14px;cursor:pointer;font-size:12px}
    .btn.gray{background:#2e4852}
    @media print{ .actions{display:none!important} .page{box-shadow:none;border-radius:0;margin:0;width:auto} .ribbon{padding-bottom:8px} }
  </style>
</head>
<body>
  <div class="actions">
    <button id="btnExport" class="btn">Descargar PDF</button>
    <button id="btnPrint" class="btn gray">Imprimir</button>
  </div>

  <div id="printArea" class="page">
    <div class="ribbon">
      <div class="ribbon-inner">
        <div class="brand">
          <div class="logo"><img id="agencyLogo" alt="Logo"/></div>
          <div>
            <h1 id="agencyName">Dream Vacation</h1>
            <small id="agencyLegalName">Agencia Mayorista de Viajes y Turismo</small>
          </div>
        </div>
        <div class="fact-box">
          <div class="fact-title">N° Factura y Contrato</div>
          <div class="kv">
            <div>Factura:</div><div id="invoiceNumber" class="v">N/A</div>
            <div>Fecha:</div><div id="invoiceDate" class="v">N/A</div>
            <div>Asesor:</div><div id="invoiceAdvisor" class="v">N/A</div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="sect">
        <span class="sect-title">Datos del titular</span>
        <div class="box">
          <div class="line">
            <div class="item"><span class="lbl">Nombre:</span><span class="val" id="clientFullName">N/A</span></div>
            <div class="item"><span class="lbl">Documento:</span><span class="val" id="clientDocument">N/A</span></div>
          </div>
          <div class="line">
            <div class="item"><span class="lbl">Correo:</span><span class="val" id="clientEmail">N/A</span></div>
            <div class="item"><span class="lbl">Teléfono:</span><span class="val short" id="clientPhone">N/A</span></div>
            <div class="item" style="flex:1"><span class="lbl">Dirección:</span><span class="val" id="clientAddress">N/A</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Contacto de emergencia</span>
        <div class="box">
          <div class="line">
            <div class="item"><span class="lbl">Nombre:</span><span class="val" id="emergencyName">N/A</span></div>
            <div class="item"><span class="lbl">Celular:</span><span class="val short" id="emergencyPhone">N/A</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Datos de la reserva</span>
        <div class="box">
          <div class="line">
            <div class="item"><span class="lbl">Origen:</span><span class="val short" id="travelOrigin">N/A</span></div>
            <div class="item"><span class="lbl">Destino:</span><span class="val short" id="travelDestination">N/A</span></div>
            <div class="item"><span class="lbl">Ida:</span><span class="val short" id="travelDeparture">N/A</span></div>
            <div class="item"><span class="lbl">Regreso:</span><span class="val short" id="travelReturn">N/A</span></div>
          </div>
          <div class="line">
            <div class="item"><span class="lbl">Noches:</span><span class="val short" id="travelNights">0</span></div>
            <div class="item"><span class="lbl">Días:</span><span class="val short" id="travelDays">0</span></div>
            <div class="item"><span class="lbl">Pasajeros:</span><span class="val" id="passengerTotals">ADT(0), CHD(0), INF(0)</span></div>
          </div>
          <div class="separator"></div>
          <div class="line">
            <div class="item"><span class="lbl">Aerolínea:</span><span class="val" id="flightAirline">N/A</span></div>
            <div class="item"><span class="lbl">Plan:</span><span class="val short" id="flightCategory">N/A</span></div>
            <div class="item" style="flex:1"><span class="lbl">Equipaje:</span><span class="val" id="baggageSummary">—</span></div>
          </div>
          <div class="line">
            <div class="item" style="flex:1"><span class="lbl">Ciclo de vuelo:</span><span class="val" id="flightCycle">N/A</span></div>
          </div>
          <div class="separator"></div>
          <div class="line">
            <div class="item"><span class="lbl">Hotel:</span><span class="val" id="hotelName">N/A</span></div>
            <div class="item"><span class="lbl">Habitación:</span><span class="val" id="hotelRoomType">N/A</span></div>
            <div class="item"><span class="lbl">Plan de alimentación:</span><span class="val" id="hotelMealPlan">N/A</span></div>
          </div>
          <div class="line">
            <div class="item" style="flex:1"><span class="lbl">(N° habitaciones / ADT / CHD / INF):</span><span class="val" id="accommodationsSummary">—</span></div>
          </div>
          <div class="line">
            <div class="item" style="flex:1"><span class="lbl">Otras inclusiones:</span><span class="val" id="otherInclusions">—</span></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <span class="sect-title">Traslados</span>
            <div class="box"><div id="transfersSummary2" class="text-[11.5px] text-[color:var(--gris-txt)]">No hay traslados registrados.</div></div>
          </div>
          <div>
            <span class="sect-title">Tours</span>
            <div class="box"><div id="toursContent" class="text-[11.5px] text-[color:var(--gris-txt)]">No hay tours o servicios adicionales registrados.</div></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <span class="sect-title">Detalles de cobro</span>
        <table>
          <thead>
            <tr>
              <th style="width:10%">Cant.</th>
              <th>Descripción</th>
              <th style="width:18%">Vr. Unit.</th>
              <th style="width:18%">Vr. Total</th>
            </tr>
          </thead>
          <tbody id="paymentsBody">
            <tr><td colspan="4" class="text-center">No hay información de pagos.</td></tr>
          </tbody>
        </table>
        <div class="totals">
          <div class="tline"><span>Subtotal</span><span id="paymentsSubtotal">—</span></div>
          <div class="tline"><span>Recargo</span><span id="paymentsSurcharge">—</span></div>
          <div class="tline grand"><span>Total</span><span id="paymentsTotal">—</span></div>
          <div style="font-size:11px;color:var(--gris-txt);margin-top:2px">En letras: <strong id="paymentsTotalWords">—</strong></div>
        </div>
      </div>

      <div class="sect" style="margin-top:6px">
        <div class="grid grid-cols-2 gap-2">
          <div class="box">
            <div class="h-10 flex items-center justify-center border border-[color:var(--gris-borde)] bg-white rounded mb-1">Firma asesor</div>
            <div id="signatureAdvisor" class="text-center text-[11px] text-[color:var(--gris-txt)]">N/A</div>
          </div>
          <div class="box">
            <div class="h-10 flex items-center justify-center border border-[color:var(--gris-borde)] bg-white rounded mb-1">Firma titular</div>
            <div id="signatureClient" class="text-center text-[11px] text-[color:var(--gris-txt)]">N/A</div>
          </div>
        </div>
      </div>

      <div class="legal">
        <div id="invoiceMessage"></div>
        <div id="footerTerms"></div>
        <div id="footerNote"></div>
        <div style="margin-top:4px;opacity:.95">
          ESTA FACTURA DE VENTA SE ASIMILA EN TODOS SUS EFECTOS A UNA LETRA DE CAMBIO SEGÚN ART.774 DEL C. DE CIO.
        </div>
      </div>
    </div>
  </div>

  <script>
    const parseDate = (v)=>{ if(!v) return null; if(v instanceof Date) return v; const s=String(v); const d=new Date(s); if(!isNaN(d)) return d; const m=s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); return m? new Date(Date.UTC(+m[1],+m[2]-1,+m[3])): null; };
    const two=(n)=>String(n).padStart(2,'0');
    const formatDate=(v)=>{ const d=parseDate(v); if(!d) return 'N/A'; return two(d.getUTCDate())+'/'+two(d.getUTCMonth()+1)+'/'+d.getUTCFullYear(); };
    const formatCurrency=(n,cur='COP')=>{ const x=Number(n); if(!Number.isFinite(x)) return '—'; try{ return new Intl.NumberFormat('es-CO',{style:'currency',currency:cur,maximumFractionDigits:0}).format(x);}catch{return cur+' '+x.toLocaleString('es-CO');} };
    const numeroALetras=(num)=>{ if(!Number.isFinite(num)) return ''; const u=['','UNO','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE']; const e={10:'DIEZ',11:'ONCE',12:'DOCE',13:'TRECE',14:'CATORCE',15:'QUINCE',16:'DIECISEIS',17:'DIECISIETE',18:'DIECIOCHO',19:'DIECINUEVE',20:'VEINTE',21:'VEINTIUNO',22:'VEINTIDOS',23:'VEINTITRES',24:'VEINTICUATRO',25:'VEINTICINCO',26:'VEINTISEIS',27:'VEINTISIETE',28:'VEINTIOCHO',29:'VEINTINUEVE'}; const d=['','','VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA']; const c=['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS','NOVECIENTOS']; const sec=(n)=>{ if(n===0) return ''; if(n<10) return u[n]; if(n<30) return e[n]; if(n<100){const D=Math.floor(n/10),R=n%10;return d[D]+(R?' Y '+u[R]:'');} if(n===100) return 'CIEN'; if(n<1000){const C=Math.floor(n/100),R=n%100;return c[C]+(R?' '+sec(R):'');} if(n<1e6){const M=Math.floor(n/1e3),R=n%1e3;return (M===1?'MIL':sec(M)+' MIL')+(R?' '+sec(R):'');} if(n<1e9){const MM=Math.floor(n/1e6),R=n%1e6;return (MM===1?'UN MILLON':sec(MM)+' MILLONES')+(R?' '+sec(R):'');} const B=Math.floor(n/1e9),R2=n%1e9;return (B===1?'UN BILLON':sec(B)+' BILLONES')+(R2?' '+sec(R2):''); }; const ent=Math.floor(Math.abs(num)); const cents=Math.round((Math.abs(num)-ent)*100); let out=ent===0?'CERO':sec(ent); out+=' PESOS'; if(cents>0) out+=' CON '+String(cents).padStart(2,'0')+'/100'; return out; };

    const setText=(id,v,empty='N/A')=>{ const el=document.getElementById(id); if(el) el.textContent=v? v: empty; };
    const fillTable=(tbodyId,rows,emptyCols,emptyText)=>{ const tb=document.getElementById(tbodyId); if(!tb) return; tb.innerHTML=''; if(!rows||!rows.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=emptyCols; td.textContent=emptyText; td.style.textAlign='center'; tr.appendChild(td); tb.appendChild(tr); return;} rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }); tb.appendChild(tr); }); };

    const renderInvoice=(data={})=>{
      const { agency={}, invoice={}, titular={}, emergencyContact={}, travel={}, flights={}, hotel={}, passengers={}, transfers={}, tours=[], payments={}, footer={}, signatures={} } = data;
      if(agency.logoUrl){ const lg=document.getElementById('agencyLogo'); lg.src=agency.logoUrl; }
      setText('agencyName', agency.name || 'Dream Vacation');
      setText('agencyLegalName', agency.legalName || 'Agencia Mayorista de Viajes y Turismo');
      setText('invoiceNumber', invoice.number || 'N/A');
      setText('invoiceDate', formatDate(invoice.issueDate));
      setText('invoiceAdvisor', invoice.advisorName || 'N/A');
      setText('clientFullName', titular.fullName||'N/A');
      setText('clientDocument', (titular.documentType?titular.documentType+' ':'') + (titular.document||'N/A'));
      setText('clientEmail', titular.email||'N/A');
      setText('clientPhone', titular.phone||'N/A');
      setText('clientAddress', titular.address||'N/A');
      setText('emergencyName', emergencyContact.name||'N/A');
      setText('emergencyPhone', emergencyContact.phone||'N/A');
      setText('travelOrigin', travel.origin||'N/A');
      setText('travelDestination', travel.destination||'N/A');
      setText('travelDeparture', formatDate(travel.departureDate));
      setText('travelReturn', formatDate(travel.returnDate));
      setText('travelNights', Number.isFinite(travel.nights)?travel.nights:'0');
      setText('travelDays', Number.isFinite(travel.days)?travel.days:'0');
      const adt = passengers.totals?.adt ?? 0;
      const chd = passengers.totals?.chd ?? 0;
      const inf = passengers.totals?.inf ?? 0;
      document.getElementById('passengerTotals').textContent = `ADT(${adt}), CHD(${chd}), INF(${inf})`;
      setText('flightAirline', flights.airline||'N/A');
      setText('flightCategory', flights.category||'N/A');
      setText('flightCycle', flights.cycle||'N/A');
      const bag=[]; if(flights.baggage?.summary) bag.push('Artículo de mano: '+flights.baggage.summary); if(flights.baggage?.cabin) bag.push('Cabina: '+flights.baggage.cabin); if(flights.baggage?.hold) bag.push('Bodega: '+flights.baggage.hold);
      document.getElementById('baggageSummary').textContent = bag.length? bag.join(' | ') : '—';
      setText('hotelName', hotel.name||'N/A');
      setText('hotelRoomType', hotel.roomType||'N/A');
      setText('hotelMealPlan', hotel.mealPlan||'N/A');
      let rooms = 0, a=0, c=0, i=0; if(Array.isArray(hotel.accommodations)){ hotel.accommodations.forEach(h=>{ rooms += Number(h.rooms||0); a += Number(h.adt||0); c += Number(h.chd||0); i += Number(h.inf||0); }); }
      document.getElementById('accommodationsSummary').textContent = rooms? `${rooms} / ADT:${a} CHD:${c} INF:${i}` : '—';
      const other = []; if(Array.isArray(tours)&&tours.length){ other.push('Tours: '+tours.map(t=>t.name).filter(Boolean).join(', ')); } if(Array.isArray(data.assistance)&&data.assistance.length){ other.push('Asistencias: '+data.assistance.map(a=>a.planType||a.provider).filter(Boolean).join(', ')); }
      document.getElementById('otherInclusions').textContent = other.length? other.join(' | ') : '—';
      const trArr = Array.isArray(transfers.detail)? transfers.detail.map((t,i)=>`${i+1}. ${t.label||t.type||'Traslado'} ${t.date?('('+formatDate(t.date)+')'):''}`):[];
      document.getElementById('transfersSummary2').textContent = trArr.length? trArr.join('  •  ') : 'No hay traslados registrados.';
      const toursRows = Array.isArray(tours) ? tours.filter(Boolean).map((t,i)=> `${i+1}. ${t.name||'Servicio'} ${t.date?(' - '+formatDate(t.date)):''}`) : [];
      const toursBox = document.getElementById('toursContent');
      toursBox.innerHTML = toursRows.length ? '<ul style="margin:2px 0 2px 16px">'+toursRows.map(x=>`<li>${x}</li>`).join('')+'</ul>' : 'No hay tours o servicios adicionales registrados.';
      const rows = Array.isArray(payments.lineItems) ? payments.lineItems.map(li=>[ li.quantity??0, li.label||li.code||'Concepto', formatCurrency(li.unitPrice, payments.currency||'COP'), formatCurrency(li.amount, payments.currency||'COP') ]) : [];
      fillTable('paymentsBody', rows, 4, 'No hay información de pagos.');
      setText('paymentsSubtotal', formatCurrency(payments.subtotal||0, payments.currency||'COP'));
      setText('paymentsSurcharge', formatCurrency(payments.surcharge||0, payments.currency||'COP'));
      setText('paymentsTotal', formatCurrency(payments.total||0, payments.currency||'COP'));
      document.getElementById('paymentsTotalWords').textContent = numeroALetras(Math.round(payments.total||0)) || '—';
      setText('signatureAdvisor', signatures.advisor||'N/A');
      setText('signatureClient', signatures.client||'N/A');
      document.getElementById('invoiceMessage').textContent = footer.invoiceMessage||'';
      document.getElementById('footerTerms').textContent = footer.terms||'';
      document.getElementById('footerNote').textContent = footer.footerNote||footer.contractMessage||'';
    };

    window.renderInvoice = renderInvoice;
    window.numeroALetras = numeroALetras;
    document.getElementById('btnExport').addEventListener('click', () => {
      const area = document.getElementById('printArea');
      const filename = document.getElementById('invoiceNumber').textContent || 'Factura';
      const opt = { margin: [8,8,8,8], filename: filename + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: [8.5, 13], orientation: 'portrait' } };
      html2pdf().set(opt).from(area).save();
    });
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
  </script>
</body>
</html>
